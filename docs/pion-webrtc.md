# Pion WebRTC

官方文档：https://webrtcforthecurious.com/zh/

Pion WebRTC 是一个纯 Go 实现的 WebRTC 框架，早期 WebRTC 只有 JS 实现，应用在浏览器中。

**WebRTC 工作流程主要分为四个步骤**：

- **信令**（Signaling）

  信令使用 SDP（会话描述协议，是一个文本协议，保存KV）为 peer 提供上报连接和通信配置信息的功能。信令从英文理解应该是这个上报动作，应该也是需要依赖一个公开的服务器节点作为信令服务器，保存这些连接和通信配置信息，进而实现引导呼叫。

  SDP 协议包含 7 个key:

  - `v` - Version，版本，版本，应等于 `0`。
  - `o` - Origin，源，包含一个唯一 ID，用于重新协商。
  - `s` - Session Name，会话名称，应等于`-`。
  - `t` - Timing，时间，应等于 `0 0`。
  - `m` - Media Description(`m=<media> <port> <proto> <fmt> ...`)，媒体描述，下面有详细说明。
  - `a` - Attribute，属性，一个自由文本字段，这是 WebRTC 中最常见的行。
  - `c` - Connection Data，连接数据，应等于 `IN IP4 0.0.0.0`。

  SDP 一些常用的属性：[WebRTC 用到的 SDP 值](https://webrtcforthecurious.com/zh/docs/02-signaling/#webrtc-%e7%94%a8%e5%88%b0%e7%9a%84-sdp-%e5%80%bc)。

- **连接**（Connecting）

  经过第一步信令消息的上报，两个 WebRTC Agent 知道足够的详细信息后可以通过 ICE（Interactive Connectivity Establishment，交互式连接建立）尝试相互连接。

  ICE 通过 NAT 映射实现寻找内网的某台机器，借助 STUN 协议可以以编程的方式创建 NAT 映射，还支持查看映射的详细信息，可以帮助两个客户端之间进行 NAT “打洞”或者协调 TURN 在两个客户端中间充当中继服务。

- **安全加密**（Securing）

  成功建立连接之后，为了保证通信安全还需要通过 DTLS 和 SRTP 协议加密传输层。

- **通信**（Communicating）

  传输层加密后有了安全的通信通道，然后可以使用 RTP（实时传输协议）和 SCTP（流控制传输协议）封装数据报进行通信。使用 RTP 来交换用 SRTP 加密过的媒体数据，使用 SCTP 发送和接收那些用 DTLS 加密过的 DataChannel 消息。

**WebRTC 中一些关键概念**：

+ **NAT 类型**

  内网访问外网 IPv4 需要使用 NAT 建立端口映射复用公网IP地址，NAT 会给后面的每一个设备都分配一个单独的内网地址，NAT 内部将维护一个内外网的地址映射表格。访问外网建立的映射，可以被外网使用实现访问内网；

  NAT为了保护内网设备不被攻击引入了两个安全策略：1. NAT超时、2.NAT墙。

  NAT墙有四种策略（也有说7种类型，不过其中三种其实不属于NAT通信），即上面说的NAT类型：

  + Open Internet（不是NAT）

    主机具有公网IP，允许主动发起和被动响应两种方式的UDP通信。

  + UDP Blocked（不是NAT）

    位于防火墙之后，并且防火墙阻止了UDP通信。

  + Symmetric Firewall （不是NAT）

    主机具有公网IP，但位于防火墙之后，且防火墙阻止了外部主机的主动UDP通信。

  + **Full Cone NAT**（完全锥形NAT）

    当内网主机创建一个UDP socket并通过它第一次向外发送UDP数据包时，NAT会为之分配一个**固定的公网{IP:端口}**。此后，通过这个socket发送的任何UDP数据包都是通过这个公网{IP:端口}发送出去的；同时，**任何外部主机都可以使用这个公网{IP:端口}向该socket发送UDP数据包**。即是说，NAT维护了一个映射表，内网主机的内网{IP:端口}与公网{IP:端口}是一一对应的关系。一旦这个映射关系建立起来(内部主机向某一外部主机发送一次数据即可)，任何外部主机就可以直接向NAT内的这台主机发起UDP通信了，此时NAT透明化了。

    这里强调任何外部主机，即**任何外部主机IP、端口**，都可以通过内网主机在公网映射的IP端口访问内网主机。

  + **Restricted Cone NAT**（IP限制锥形NAT）

    当内网主机创建一个UDP socket并通过它第一次向外发送UDP数据包时，NAT会为之分配一个**固定的公网{IP:端口}**。此后，通过这个socket向外发送的任何UDP数据包都是通过这个公网{IP:端口}发送出去的；而**任何收到过从这个socket发送来的数据的外部主机(由IP标识)，都可以通过这个公网{IP:端口}向该socket发送UDP数据包**，其他外部IP的请求会被**丢包**。即是说，NAT维护了一个内网{IP:端口}到公网{IP:端口}的映射，还维护了一个{外部主机IP, 公网{IP:端口}}到内网{IP:端口}的映射。因此，要想外部主机能够主动向该内部主机发起通信，必须先由该内部主机向这个外部发起一次通信。

    这里强调收到内网请求的外部主机，即**之前收到过内网请求的外部主机IP，任何端口**，都可以通过内网主机在公网映射的IP端口访问内网主机。

  + **Port Restricted Cone NAT**（端口限制锥形NAT）

    当内网主机创建一个UDP socket并通过它第一次向外发送UDP数据包时，NAT会为之分配一个**固定的公网{IP:端口}**。此后，通过这个socket向外部发送的任何UDP数据包都是通过这个公网{IP:端口}发送出去的；一旦**外部主机在{IP:端口}上收到过从这个socket发送来的数据后，都可以通过这个外部主机{IP:端口}向该socket发送UDP数据包**。即是说，NAT维护了一个从内网{IP:端口}到公网{IP:端口}的映射，还维护了一个从{外部主机{IP:端口}, 公网{IP:端口}}到内网{IP:端口}的映射。

    这里强调收到内网请求的外部主机IP+端口，即**之前收到过内网请求的外部主机IP，端口**，才可以通过内网主机在公网映射的IP端口访问内网主机。

  + **Symmetrict NAT**（对称形NAT）

    前面3种类型是为内网主机分配一个**固定的公网{IP:端口}**访问外网，对称型 NAT 不会直接给一个内网设备分配固定的 IP 和端口访问外网，而是为访问的外网地址分配不同的{IP:端口}，可能IP不同、可能端口不同，也可能都不同；

+ **NAT 类型探测**

  按下面步骤探测：

  1. 判断是否存在 NAT，客户端主动发一个请求到 STUN 服务的 “IP1 端口 1” 上，STUN 服务把收到的请求的 IP 和端口直接返回给客户端，客户端会将 STUN 服务返回的 IP 和端口跟自己的 IP 和端口进行比较，

     1. 如果一致，则表明客户端处在公网中，或者说客户端没有在 NAT 之后；
     2. 如果不一致，则表明客户端处在 NAT 之后，需要往下走继续探测 NAT 类型；

  2. 判断 NAT 是不是 Full Cone NAT（完全锥形），客户端发送请求到 STUN 服务的 “IP1 端口 1”，STUN 服务收到请求之后用 “IP2 端口 2” 主动往客户端发送一个请求，

     1. 如果客户端能够收到 STUN 服务 IP2 的请求，则表明 NAT 策略非常宽松来者不拒，是完全锥形；
     2. 如果客户端没办法收到 STUN 服务 IP2 的请求，则数据包被 NAT 丢弃了，NAT 不是完全锥形，需要往下走继续探测 NAT 类型；

  3. 判断 NAT 是不是 Symmetric NAT（对称形），客户端主动往 STUN 服务的 “IP2 端口 2” 发送请求，STUN 服务收到请求之后把请求的来源 IP 和端口直接返回给客户端，客户端用收到的 IP 和端口跟 “第一步” 中的 IP 和端口进行比较，

     1. 如果两次收到的端口不一致，则表明 NAT 是对称形的；
     2. 如果一致，则表明 NAT 不是对称形的，需要进一步探测 NAT 类型；

  4. 判断 NAT 对端口的限制，客户端主动往 STUN 服务的 “IP2 端口 2” 发请求，要求 STUN 服务用 “IP2 端口 3” 往客户端发请求，

     1. 如果客户端收到了 “IP2 端口 3” 的请求，则表明 NAT 没有对端口进行限制，是 Restricted Cone NAT（IP 限制锥形）；
     2. 如果没收到请求，则表明 NAT 限制了端口，是 Port Restricted Cone NAT（端口限制锥形）； 	

  > NAT探测软件：
  >
  > 没明白 pion/stun 接口怎么使用？官方文档基本没有，需要读 STUN 规范文档了解使用方法，不过暂时可以借助这个软件 [NatTypeTester](https://github.com/HMBSbige/NatTypeTester/releases/download/3.4/NatTypeTester.exe) 检测。

+ **NAT 打洞**

  前面说2种限制锥型NAT，会丢弃来源自自己未访问过的地址的包，并不是说一定要访问成功才算访问过，即使访问失败也算访问过，后续这个来源的包都能通过限制规则，打洞就是依靠的这个原理，即**“洞”的本质是访问记录**。

  比如两个Peer分别位于不同的端口限制锥形NAT后面，这是直接访问对方的内网地址无法连通，两方需要先分别请求公网上的STUN服务器，STUN服务器解析两个 Peer 的公网IP端口，分别发给对端Peer，对端 Peer 接收到后相互访问对方公网IP端口，虽然第一次双方的包都会被对方丢弃，但是却留下了访问过对方的记录（“洞”），下次再请求对方公网IP端口因为已经有了“洞”，就可以通过限制规则检查成功建立连接。

  **对称型 NAT 为何无法打洞？**

  因为对称型NAT讲究“专款专用”，比如 Peer A 连接 STUN ，STUN检测到 Peer A 公网IP端口是 10.0.0.1:1000， Peer B 连接 STUN ，STUN检测到 Peer B 公网IP端口是 10.0.0.2:3000, STUN 协调双方互联对方公网IP, 打的洞分别是 Peer A -> 10.0.0.2:3000, Peer B -> 10.0.0.1:1000，但是建立连接时 Peer A 连接 Peer B 可能使用的公网IP端口是 10.0.0.1:2000，对应的 Peer B 连接 Peer A 可能使用的公网IP端口是 10.0.0.2:4000，即**打得洞和实际的公网IP端口不同**。

+ **ICE 候选者**

  在 WebRTC 中，**ICE（Interactive Connectivity Establishment）候选者（Candidate）** 是用于建立对等连接（P2P）的网络地址和端口组合。ICE 候选者分为三种主要类型：**Host Candidate**、**Server Reflexive Candidate** 和 **Relayed Candidate**。每种类型的候选者有不同的生成方式和适用场景，以下是它们的详细区别：

  | **类型**     | **Host Candidate**       | **Server Reflexive Candidate** | **Relayed Candidate**    |
  | :----------- | :----------------------- | :----------------------------- | :----------------------- |
  | **地址来源** | 本地网络接口             | STUN 服务器                    | TURN 服务器              |
  | **地址类型** | 局域网地址               | 公网地址（NAT 映射）           | 中继地址                 |
  | **优先级**   | 最高                     | 中等                           | 最低                     |
  | **延迟**     | 最低                     | 中等                           | 最高                     |
  | **带宽消耗** | 最低                     | 中等                           | 最高                     |
  | **适用场景** | 同一局域网内的 Peer 通信 | 不同 NAT 后的 Peer 通信        | 直接连接失败时的备用方案 |




## 参考资料

+ [深入浅出 WebRTC 传输协议](https://mp.weixin.qq.com/s/XMhSDABc74dpALIHrPPt7w)